#/bin/bash
#we would copy ./scripts/setrw and ./scripts/unsetrw out of repo and protect them and own by root allow them to be run via sudo
#for current user
#
#/bin/bash
#dependancies:
# rsync git docker
#we should be ran from root folder of the nextcloud.git repo
PATH='/bin:/usr/bin'
IFS=' '
our_repo="https://github.com/endsguy/nextcloud.git"

#find which repo this directory belongs to
current_repo=`grep "$our_repo" .git/config | awk -F' ' '{print $3}'`

if [ "$current_repo" != "$our_repo" ]
then
  echo "please run ./scripts/initialize from root of nextcloud.git repo (same place as you docker-compose.yml file)"
  exit 1
fi


rootdir=$PWD

# header
header=$(cat <<'end_header'
#!/bin/bash
end_header
)

# script 1
setrw=$(cat <<end_setrw
chmod -R o+rw $PWD/html
end_setrw
)

# script 2 
unsetrw=$(cat <<end_unsetrw
chmod -R o-rw $PWD/html
end_unsetrw
)

echo $header
echo $setrw
echo
echo $header
echo $unsetrw

su -c "mkdir ../protected || chown root:root ../protected && chmod 755 ../protected && echo '$header' > ../protected/setrw && echo '$setrw' >> ../protected/setrw && echo '$header' > ../protected/unsetrw && echo '$unsetrw' >> ../protected/unsetrw && chown root:root ../protected/setrw ../protected/unsetrw && chmod 755 ../protected/setrw ../protected/unsetrw" root
cd ..
cur=$PWD
user=$USERNAME
echo "Please create following lines in your sudo file:"
echo "$user ALL=(ALL) NOPASSWD: $cur/protected/setrw"
echo "$user ALL=(ALL) NOPASSWD: $cur/protected/unsetrw"
cd nextcloud
